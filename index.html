<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Vehicle Monitor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style> #map { height: 100vh; } </style>
</head>
<body>
<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- MQTT.js (WebSocket) -->
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<script>
const MQTT_BROKER_WS = "ws://broker.hivemq.com:8000/mqtt"; // public ws for testing
const TOPIC = "vehicle/tracker/vehicle1";

const client = mqtt.connect(MQTT_BROKER_WS);

const map = L.map('map').setView([0,0], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'Â© OpenStreetMap contributors'
}).addTo(map);

let marker = null;
let polyline = L.polyline([], {weight: 3}).addTo(map);

client.on('connect', function() {
  console.log('MQTT connected');
  client.subscribe(TOPIC, function(err) {
    if (!err) console.log('subscribed to', TOPIC);
  });
});

client.on('message', function(topic, message) {
  try {
    const msg = JSON.parse(message.toString());
    const lat = msg.lat;
    const lng = msg.lng;
    const speed = msg.speed;
    if (!marker) {
      marker = L.marker([lat, lng]).addTo(map).bindPopup('Speed: ' + speed + ' km/h');
      map.setView([lat,lng], 16);
    } else {
      marker.setLatLng([lat, lng]).setPopupContent('Speed: ' + speed + ' km/h');
    }
    polyline.addLatLng([lat, lng]);
  } catch(e) {
    console.error('Invalid message', e);
  }
});
</script>
</body>
</html>
